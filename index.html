<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!--link rel="icon" href="../../favicon.ico"-->

    <title>Garage home</title>

    <!-- Leaflet CSS -->  
    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />  
      
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" />

    <!-- Custom styles for this template -->
    <link href="garage.css" rel="stylesheet" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
      
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" onclick="menuClick('');" id="menu-item-">Garage</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav" id="menu">
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

        <div class="main-text" id="main-text-">
            <h1>Garage system</h1>
            <p style="text-align:left">This is garage system pages v0.1</p>
            <p style="text-align:left" id="test"> Testing connection to server ... </p>
        </div>
                
        <div class="main-text" id="main-text-sms">
            <h1>SMS</h1>
            <div class="row">
                <ul class="nav nav-pills">
                    <li id="sms_newmsg_menu" class="sms_menu">
                        <a href="javascript:show_sms_newmsg('')">New message</a>
                    </li>
                    <li id="sms_inbox_menu" class="sms_menu">
                        <a href="javascript:show_sms_inbox('')">Inbox</a>
                    </li>
                    <li id="sms_outbox_menu" class="sms_menu">
                        <a href="javascript:show_sms_outbox('')">Outbox</a>
                    </li>
                    <li id="sms_balance_menu" class="sms_menu">
                        <a href="javascript:show_sms_balance('')">Balance</a>
                    </li>
                </ul>
            </div>
            <div class="row">
                <div>
                    <table class="table table-striped table-condensed" id="sms_table">
                        <thead><tr><th>Number</th><th>Date</th><th>Text</th></tr></thead>
                        <tbody id="sms_table_body"></tbody>
                    </table>
                    <div id="sms_form" class="text-left">
                        
                            <div class="form-group">
                                <label for="sms_number_input">Phone number</label>
                                <input type="text" class="form-control" id="sms_number_input" placeholder="Number">
                            </div>
                            <div class="form-group">
                                <label for="sms_text_input">SMS text</label>
                                <textarea class="form-control" id="sms_text_input" placeholder="Enter text here..."></textarea>
                            </div>
                            <a class="btn btn-default" href="javascript:send_sms()">Submit</a>
                            <span class="label label-info" id="send_status"></span>
                    </div>
                    <div id="sms_balance"></div>
                </div>
            </div>
        </div>
        
        <div class="main-text" id="main-text-event">
            <h1>Events</h1>
            <div class="row">
                <div id="events">
                </div>
            </div>
        
        </div>
        
        <div class="main-text" id="main-text-map">
            <h1>Map</h1>
            <div class="row">
                <div class="col-md-4">
                    <h4 style="text-align:left">Devices</h4>
                    <div><ul  class="list-group mono" id="device-select"></ul></div>
                    <h4 style="text-align:left">Sessions</h4>
                    <div><ul  class="list-group mono" id="session-select"></ul></div>
                </div>
                <div class="col-md-8">
                    <div id="map" class="map"></div></br>
                    <a href="javascript:loadData('',10)">Load</a>
                    <div id="info">
                        <table id="track-table"></table>
                    </div>
                </div>
            </div>
        </div>
        
    <div class="point" id="point"></div>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="lib/jquery/jquery-2.1.1.min.js"></script>
    <script src="lib/leaflet/leaflet.js"></script>
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>

<script>
    
var delta = 5;   
    
var levels = {'year':'month','month':'day','day':'hour','hour':'minute'};
    
function menuClick(item) {  
    $( ".active" ).removeClass("active");
    $( "#menu-item-" + item).addClass("active");
    $( ".main-text" ).hide();
    $( "#main-text-" + item ).show();
}
  
function show_sms_inbox(param) {
    $("#sms_form").hide();
    $(".sms_menu").removeClass("active");
    $("#sms_inbox_menu").addClass("active");
    $("#sms_table_body").html("");
    $.getJSON( "http://pi/server.php?cmd=show_sms_inbox"+param, 
        function( data ) {
            var str = '';
            $.each( data, function( key, val ) {
                str += "<tr>";
                str += "<td>"+val['number']+"</td>";
                str += "<td>"+val['date']+"</td>";
                str += "<td align=left>"+val['text']+"</td>";
                str += "</tr>";
            });
            $("#sms_table_body").html(str);
    });
    $("#sms_table").show();
}
 
function show_sms_outbox(param) {
    $("#sms_form").hide();
    $(".sms_menu").removeClass("active");
    $("#sms_outbox_menu").addClass("active");
    $("#sms_table_body").html("");
    $.getJSON( "http://pi/server.php?cmd=show_sms_outbox"+param, 
        function( data ) {
            var str = '';
            $.each( data, function( key, val ) {
                str += "<tr>";
                str += "<td>"+val['number']+"</td>";
                str += "<td>"+val['date']+"</td>";
                str += "<td>"+val['text']+"</td>";
                str += "</tr>";
            });
            $("#sms_table_body").html(str);
    });
    $("#sms_table").show();
}

function show_sms_newmsg() {
    $("#sms_table").hide();
    $("#sms_form").show();
    $(".sms_menu").removeClass("active");
    $("#sms_newmsg_menu").addClass("active");
}
    
function send_sms() {
    var param = "&number=" + encodeURIComponent($("#sms_number_input").val());
    param += "&text=" + encodeURIComponent($("#sms_text_input").val()); 
    $.getJSON( "http://pi/server.php?cmd=send_sms"+param, function( data ) {
        $("#send_status").html(data['result']);        
     });
}
  
function show_sms_balance() {
    $("#sms_table").hide();
    $("#sms_form").hide();
    $(".sms_menu").removeClass("active");
    $("#sms_balance_menu").addClass("active");
    $.getJSON( "http://pi/server.php?cmd=balance", function( data ) {
        $("#sms_balance").html("balance - "+data['balance']);
     });
}    
    
function loadData(param,range) {
    //+"&range="+(range*1)+","+(delta*1)
    /*
    $.getJSON( "http://accmon.segalla.ru/server.php?cmd=list_track"+param, 
        function( data ) {
            var str = '';
            $.each( data, function( key, val ) {
                str += "<tr class='dev-"+val['UUID']+" session-"+val['session']+"' >";
                str += "<td>"+val['id']+"</td>";
                str += "<td>"+val['time']+"</td>";
                
                str += "</tr>";
            });
            if(range*1==0) {
                $("#track-table").html("");
            }
            $("#track-table").append(str);
        });
        */
    //$("#main-text-raw-load-more").html("<span class='btn btn-default' id='load-more' onClick=\"loadRangeRawData('"+param+"',"+(range+delta)+")\" >Load more...</span>");
}   
    
function showMapTrack(session) {
    //alert(session);
    /*
    if (!$("#session-"+session).hasClass("active")) {
        $.getJSON( "http://pi/server.php?cmd=get_track&session="+session, 
            function( data ) {
                var myLayer = L.geoJson().addTo(map);
                myLayer.addData(data);
                setView();
                mapLayers[session] = myLayer;
                loadData("&session="+session,0);
            });
        $("#session-"+session).addClass("active");
    } else {
        map.removeLayer(mapLayers[session]);
        setView();
        $("#session-"+session).removeClass("active");
    }
    */
}
    
function show_events(level,id,param) {
    $.getJSON( "http://pi/server.php?cmd=events&group="+level+param, 
        function( data ) {
            $.each( data, function( key, val ) {
                var element=val[level];
                s =  "<div type=\"button\" class=\"btn btn-default list-group-item\" id="+id+"-"+element;
                if(level!='minute') {
                    s += " onClick=\"show_events('"+levels[level]+"','"+id+'-';
                    s += element+"','"+param+"&"+level+"="+element+param+"')\"";
                }
                s += "><b>"+id+"-"+element+"</b> "+ val["temp"]+"</div>";
                $(s).insertAfter("#"+id);
            });
        });
}    
    
function showMapSessions(device) {
    if($("#dev-"+device).hasClass("active")) {
        $(".dev-"+device).hide();
        $("#dev-"+device).removeClass("active");
    } else {
        $(".dev-"+device).show();
        $("#dev-"+device).addClass("active");
    }
}
    
function setView() {
    function findMinMax( a, b ) {
        if(maxLat==0&&minLat==0&&maxLng==0&&minLng==0) {
            maxLat = b.lat;
            minLat = b.lat;        
            maxLng = b.lng;
            minLng = b.lng;
        } else {
            if(maxLat < b.lat) maxLat = b.lat;
            if(minLat > b.lat) minLat = b.lat;
            if(maxLng < b.lng) maxLng = b.lng;
            if(minLng > b.lng) minLng = b.lng;
        }
    }
    var maxLat = 0;
    var minLat = 0;
    var maxLng = 0;
    var minLng = 0;
    $.each( map._layers , function (key, val) {
        if(typeof(val.getLatLngs) != 'undefined') {
            var latLngs = val.getLatLngs();
            $.each(latLngs, function (a , b) {
                if(typeof(b.lat)=="undefined") {
                    $.each(b , findMinMax);
                } else {
                    findMinMax(a, b);
                }
            });
        }
    });
    map.fitBounds([[maxLat, maxLng],[minLat, minLng]]);
}
    
function connectionTest() {
    $("#test").html("<p class='label label-info'>Testing conncetion to server ... </p>");
    $.getJSON("http://pi/server.php?cmd=hello") 
        .done(function( data ) {
            $("#test").html("Connection to server - <b>"+data["test"]+
                "</b><br/> Server time - "+data["time"]+" UTC <br/> Server version - "+
                data['version']+
                "<br/><div class='btn btn-primary' onClick=connectionTest()>Test again</div>");    
        })
        .fail(function( jqxhr, textStatus, error ) {
            $("#test").html("<div class='label label-danger'> Status - "+textStatus + ", error - " + error+"</div>"+
                "<br/><br/><div class='btn btn-primary' onClick=connectionTest()>Test again</div>");
        });
    $("#test").append();
}

    
// Menu data    
var menu = {
    sms : "SMS",
    event : "Events",
    control : "Control"
    //sms_out : "SMS Outbox",
    //smi_send : "SMS Send"
};
      
atr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>';
    
var map = L.map('map').setView([55.7706328701863,37.6792607577922], 13);
L.tileLayer('https://{s}.tiles.mapbox.com/v3/segallar.k96pg69g/{z}/{x}/{y}.png', {
    attribution: atr,
    maxZoom: 18
}).addTo(map);

var mapLayers = new Array();

var delta = 25;
    
// Init function
$( document ).ready( function() {
    
    // Loading ...
    $(".main-text").hide();
    
    show_sms_newmsg();
    
    // Testing connection to server
    connectionTest();
    
    // make menu
    if( location.hash == "#" || location.hash == "" ) {
        // This part dont work correctly !!! 
        $(".navbar-brand").addClass("active"); 
        $("#main-text-").show();
        active = ""; 
    } else { active = location.hash.slice(1); }
    $.each( menu , function (key, val) {
        if( active == key ) { activeClass = " class='active' "; } else { activeClass = ""; }
        $("<li onClick='menuClick("+'"'+key+'"'+")' "+activeClass+" id='menu-item-"+key+"'><a href='#"+key+"'>"+val+"</a></li>").appendTo("#menu");
    });
    if( location.hash != "" ) menuClick(active);  
    
    // load events
    
   
    
    ///!!!!!!!!
    show_events("year","events","");
        
    
    // load devices
    /*
    $.getJSON( "http://accmon.segalla.ru/server.php?cmd=list_dev", function( data ) {
        var str = '';
        $.each( data, function( key, val ) {
            $("<a class='list-group-item' id='dev-"+key+"' onClick='showMapSessions("+'"'+key+'"'+")'>").html(key).appendTo("#device-select");
            $.each( val, function (key1, val1) {
                $("<a class='list-group-item dev-"+key+"' id='session-"+val1['session']+"'  onClick='showMapTrack("+'"'+val1['session']+'"'+")'>").html(val1['session']).hide().appendTo("#session-select");
            });
        });
        $("#dev-table").html(str);
        $(".dev-cell").hide();
    });
    */
});
</script>
</body>
</html>

